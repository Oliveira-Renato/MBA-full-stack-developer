import Table from '@mui/material/Table';
import TableBody from '@mui/material/TableBody';
import TableCell from '@mui/material/TableCell';
import TableContainer from '@mui/material/TableContainer';
import TableHead from '@mui/material/TableHead';
import TableRow from '@mui/material/TableRow';
import Paper from '@mui/material/Paper';
import { getDespesas, getDespesasEndpoint } from '../server/backend';
import { useEffect, useState } from 'react';
import { IDespesas } from '../types/types';
import { Box } from '@mui/system';
import SelectFilter from '../components/Select';
import { useParams } from 'react-router-dom';

export function Home() {
  const { data } = useParams();
  const teste = data || ''
  const [despesas, setDespesas] = useState<IDespesas[]>([])
  const [years, setYears] = useState<IDespesas[]>([])
  const [total, setTotal] = useState<string>('0')

  useEffect(() => {
    (async () => {
      if (despesas.length === 0) {
        if (teste !== '' && teste !== undefined) {
          let anoMes = teste.split('-')
          const data = await getDespesas(anoMes[0], anoMes[1])
          setDespesas(data)
        } else {
          setDespesas(await getDespesasEndpoint())
        }
        setYears(await getDespesasEndpoint())
      }
    })()
  }, [data])

  function handleData(): string[] {
    let data = years.map(despesa => despesa.mes)
    let newYear = new Set<string>()

    for (let i in data) {
      let year = (data[i].split('-'))[0]
      newYear.add(year)
    }
    return Array.from(newYear) || ['']
  }

  function handleDespesaTotal() {
    if (despesas.length > 0) {
      const valorDespesas = despesas.map(despesa => despesa.valor)
      const valortotal = (valorDespesas.reduce((a, b) => b + a)).toFixed(2).toString().replace('.', ',')
      setTotal(valortotal)
    }
  }

  return (
    <Box
      sx={{ padding: '40px' }}>
      {/* filtro */}
      <Box sx={{ display: 'flex', alignItems: 'center' }}>
        <Box>
          <SelectFilter data={handleData()} />
        </Box>
        <Box sx={{ flex: '1', textAlign: 'right' }}>
          Despesa total: <strong>R$ {total}</strong>
        </Box>
      </Box>
      {/* table */}
      <TableContainer component={Paper}>
        <Table sx={{ minWidth: 650, margin: '20px' }} aria-label="simple table">
          <TableHead>
            <TableRow>
              <TableCell align="center">Despesa</TableCell>
              <TableCell align="center">Categorias</TableCell>
              <TableCell align="center">Dias</TableCell>
              <TableCell align="center">Valor (R$)</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {/* map data here */}
            {despesas.map((despesa, idx) => (
              <TableRow
                key={idx}
                sx={{ '&:last-child td, &:last-child th': { border: 0 } }}
              >
                <TableCell align="center">{despesa.descricao}</TableCell>
                <TableCell align="center">{despesa.categoria}</TableCell>
                <TableCell align="center">{despesa.dia}</TableCell>
                <TableCell align="center">{despesa.valor}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </Box>
  )
}